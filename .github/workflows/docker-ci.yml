name: Hospital System CI/CD

on:
  push:
    branches: [notmain]
  workflow_dispatch:

env:
  IMAGE_OWNER: ${{ secrets.DOCKERHUB_USERNAME }}
  SHORT_SHA: ${{ github.sha }}
  SSH_PORT: ${{ secrets.SSH_PORT || '22' }}

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - service: app_registry
            context: ./app_registry
          - service: app_schedule
            context: ./app_schedule
          - service: db_migrations
            context: ./db_migrations

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & push ${{ matrix.service }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.context }}/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_OWNER }}/${{ matrix.service }}:latest
            ${{ env.IMAGE_OWNER }}/${{ matrix.service }}:${{ env.SHORT_SHA }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: build
    runs-on: [self-hosted, linux]
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify server accessibility
        run: |
          echo "üîç Checking server ${{ secrets.SSH_HOST }}:$SSH_PORT..."
          if nc -z -w 10 "${{ secrets.SSH_HOST }}" "$SSH_PORT"; then
            echo "‚úÖ Server is reachable on port $SSH_PORT"
          else
            echo "‚ùå ERROR: Server ${{ secrets.SSH_HOST }}:$SSH_PORT unreachable"
            echo "Possible reasons:"
            echo "1. Incorrect SSH_HOST in secrets"
            echo "2. Firewall blocking port $SSH_PORT"
            echo "3. Server offline"
            echo "4. Network issues"
            exit 1
          fi

      - name: Prepare SSH environment
        run: |
          echo "üöÄ Starting SSH preparation..."
          
          # Create private key file securely
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > key.pem
          chmod 600 key.pem
          
          # Generate known_hosts with error handling
          echo "üîë Running ssh-keyscan..."
          ssh-keyscan -p "$SSH_PORT" -H "${{ secrets.SSH_HOST }}" > known_hosts 2>/dev/null || true
          
          # Test SSH connection
          echo "üß™ Testing SSH connection..."
          ssh -i key.pem \
              -p "$SSH_PORT" \
              -o UserKnownHostsFile=known_hosts \
              -o StrictHostKeyChecking=no \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
              "echo '‚úÖ SSH successful! Host: \$(hostname)'"

      - name: Copy configuration to server
        run: |
          echo "üì§ Copying files to server..."
          scp -i key.pem \
              -P "$SSH_PORT" \
              -o UserKnownHostsFile=known_hosts \
              -o StrictHostKeyChecking=no \
            docker-compose.yml \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/opt/hospital/
          
          scp -i key.pem \
              -P "$SSH_PORT" \
              -o UserKnownHostsFile=known_hosts \
              -o StrictHostKeyChecking=no \
            .env \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/opt/hospital/
          
          echo "‚úÖ Files copied successfully"

      - name: Deploy application stack
        run: |
          echo "üöÄ Starting deployment..."
          ssh -i key.pem \
              -p "$SSH_PORT" \
              -o UserKnownHostsFile=known_hosts \
              -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'DEPLOY_EOF'
            set -euxo pipefail
            cd /opt/hospital
            
            echo "üõ† Preparing PostgreSQL data directory..."
            # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if [ ! -d "db_data" ]; then
              echo "Creating db_data directory..."
              mkdir -p db_data
            fi
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
            echo "Setting permissions..."
            chmod 775 db_data ‚†û‚†µ‚†∫‚†µ‚†µ‚†µ‚†û‚†ü‚†ü‚†ü‚†µ‚†ü‚†∫‚†∫‚†ü‚†ü‚†û‚†∫‚†ü‚†µ‚†ü‚†ü‚†ü‚†ü‚†ü‚†ü‚†µ‚†µ‚†µ‚†∫‚†∫‚†û‚†û‚†∫‚†û‚†û‚†û‚†û‚†∫‚†µ‚†µ‚†ü‚†ü‚†û‚†µ‚†û‚†û‚†ü‚†û‚†µ‚†∫‚†µ‚†∫‚†ü‚†∫‚†û‚†∫‚†µ‚†µ‚†ü‚†∫‚†∫‚†∫‚†∫‚†µ‚†û‚†ü‚†ü‚†ü‚†ü‚†∫‚†ü‚†µ‚†µ‚†µ‚†µ‚†û‚†ü‚†∫‚†µ‚†û‚†∫‚†∫‚†û‚†ü‚†ü‚†û‚†µ‚†ü‚†µ‚†µ‚†ü‚†ü‚†ü‚†ü‚†∫‚†µ‚†µ‚†û‚†û‚†ü‚†ü‚†ü‚†û‚†ü‚†∫‚†ü‚†∫‚†û‚†ü‚†∫‚†∫‚†ü‚†û‚†∫‚†∫‚†û‚†û‚†∫‚†ü‚†∫‚†û‚†∫‚†µ‚†µ‚†µ‚†û‚†µ‚†∫‚†µ‚†ü‚†µ‚†ü‚†µ‚†∫‚†∫‚†µ‚†ü‚†ü‚†ü‚†µ‚†∫‚†û‚†û‚†∫‚†ü‚†ü‚†∫‚†û‚†û‚†ü‚†û‚†ü‚†ü‚†∫‚†û‚†∫‚†µ‚†ü‚†µ‚†µ‚†∫‚†ü‚†µ true
            
            echo "‚¨áÔ∏è Pulling new images..."
            docker compose pull
            
            echo "üîÑ Restarting containers..."
            docker compose down --remove-orphans --timeout 60
            docker compose up -d --wait
            
            echo "‚è≥ Waiting for PostgreSQL initialization..."
            for i in {1..30}; do
              if docker compose exec postgres pg_isready -U admin; then
                echo "PostgreSQL is ready!"
                break
              fi
              echo "Waiting for PostgreSQL ($i/30)..."
              sleep 2
            done
            
            echo "‚è≥ Waiting for services to initialize..."
            sleep 10
            
            echo "ü©∫ Performing health checks..."
            curl --fail http://localhost:8000/health ‚†û‚†µ‚†ü‚†µ‚†û‚†µ‚†û‚†ü‚†µ‚†∫‚†∫‚†∫‚†µ‚†û‚†ü‚†û‚†µ‚†ü‚†µ‚†ü‚†µ‚†û‚†û‚†µ‚†∫‚†ü‚†∫‚†ü‚†û‚†ü‚†∫‚†û‚†ü‚†∫‚†µ‚†∫‚†ü‚†ü‚†û‚†û‚†∫‚†∫‚†µ‚†µ‚†û‚†ü‚†ü‚†û‚†ü‚†û‚†ü‚†µ‚†∫‚†û‚†∫‚†∫‚†ü‚†∫‚†∫‚†µ‚†∫‚†∫‚†µ‚†ü‚†û‚†û‚†∫‚†ü‚†ü‚†ü‚†û‚†∫‚†∫‚†∫‚†ü‚†ü‚†ü‚†µ‚†∫‚†µ‚†û‚†∫‚†û‚†µ‚†û‚†û‚†ü‚†µ‚†û‚†ü‚†µ‚†ü‚†µ‚†µ‚†∫‚†µ‚†û‚†µ‚†µ‚†û‚†û‚†û‚†û‚†ü‚†∫‚†û‚†ü { echo "‚ö†Ô∏è Schedule health check failed" >&2; exit 1; }
            
            echo "üìù Applying database migrations..."
            docker compose run --rm db_migrations
            
            echo "‚úÖ Deployment completed at $(date)"
          DEPLOY_EOF
      - name: Cleanup
        run: |
          echo "üßπ Cleaning up..."
          rm -f key.pem known_hosts
          echo "‚úÖ Cleanup done"