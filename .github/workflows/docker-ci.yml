name: Hospital System CI/CD

on:
  push:
    branches: [notmain]
  workflow_dispatch:

env:
  IMAGE_OWNER: ${{ secrets.DOCKERHUB_USERNAME }}
  SHORT_SHA: ${{ github.sha }}

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - service: app_registry
            context: ./app_registry
          - service: app_schedule
            context: ./app_schedule
          - service: db_migrations
            context: ./db_migrations

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & push ${{ matrix.service }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.context }}/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_OWNER }}/${{ matrix.service }}:latest
            ${{ env.IMAGE_OWNER }}/${{ matrix.service }}:${{ env.SHORT_SHA }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare SSH environment
        run: |
          echo "Starting SSH preparation..."
          
          # Создаем файл с ключом
          echo "Creating SSH key file..."
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > key.pem
          chmod 600 key.pem
          
          # Создаем known_hosts
          echo "Creating known_hosts file..."
          ssh-keyscan -H ${{ secrets.SSH_HOST }} > known_hosts 2>/dev/null || true
          
          # Проверяем файлы
          echo "File verification:"
          ls -la key.pem known_hosts
          echo "Key file content (first line):"
          head -1 key.pem
          echo "Known hosts content:"
          cat known_hosts
          
          # Тестируем подключение
          echo "Testing SSH connection..."
          ssh -i key.pem -o UserKnownHostsFile=known_hosts -o StrictHostKeyChecking=no \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
              "echo 'SSH connection successful! Hostname: \$(hostname); Date: \$(date)'"
          
          echo "✅SSH preparation completed!"

      - name: Copy configuration to server
        run: |
          echo "Copying files to server..."
          scp -i key.pem -o UserKnownHostsFile=known_hosts -o StrictHostKeyChecking=no \
            docker-compose.yml \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/opt/hospital/
          
          scp -i key.pem -o UserKnownHostsFile=known_hosts -o StrictHostKeyChecking=no \
            .env \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/opt/hospital/
          
          echo "Files copied successfully."

      - name: Deploy application stack
        run: |
          echo "Starting deployment..."
          ssh -i key.pem -o UserKnownHostsFile=known_hosts -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'DEPLOY_EOF'
            set -euxo pipefail
            echo "Changing to /opt/hospital directory..."
            cd /opt/hospital
            
            echo "Pulling new images..."
            docker compose pull
            
            echo "Restarting containers..."
            docker compose down --remove-orphans --timeout 60
            docker compose up -d --wait
            
            echo "Waiting for services to start..."
            sleep 10
            
            echo "Performing health checks..."
            curl -f http://localhost:8000/health || echo "Registry health check failed"
            curl -f http://localhost:8001/schedules || echo "Schedule health check failed"
            
            echo "Applying database migrations..."
            docker compose run --rm db_migrations
            
            echo "✅ Deployment successful! $(date)"
          DEPLOY_EOF

      - name: Cleanup
        run: |
          echo "Cleaning up temporary files..."
          rm -f key.pem known_hosts
          echo "Cleanup completed."